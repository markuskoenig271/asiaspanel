<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asia's Panel</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.8em;
    }
    
    h2 {
      color: #667eea;
      margin-top: 24px;
      margin-bottom: 12px;
      font-size: 1.2em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    select, input[type="text"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 12px;
      transition: border-color 0.3s;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    button:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    #translated, #audioHolder, #recordStatus, #recordedAudio {
      margin-top: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 20px;
    }
    
    #recordTimer {
      margin: 12px 0;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }
    
    audio {
      width: 100%;
      margin-top: 8px;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.5em;
      }
      
      h2 {
        font-size: 1.1em;
      }
      
      button {
        padding: 10px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="container" style="max-width: 400px; margin-top: 50px;">
    <h1>üîê Asia's Panel</h1>
    <h2 style="text-align: center; border: none; margin-top: 10px;">Login</h2>
    <div style="margin-top: 24px;">
      <label for="passwordInput">Password:</label>
      <input type="password" id="passwordInput" placeholder="Enter password" style="width: 100%;">
      <button id="loginBtn" style="width: 100%; margin-top: 12px;">Login</button>
      <div id="loginError" style="color: #e74c3c; margin-top: 12px; text-align: center;"></div>
    </div>
  </div>

  <!-- Main App (Hidden until authenticated) -->
  <div id="mainApp" class="container" style="display: none;">
    <div style="text-align: right; margin-bottom: 10px;">
      <button id="logoutBtn" style="padding: 8px 16px; font-size: 14px;">üö™ Logout</button>
    </div>
    
    <h1>üé§ Asia's Panel</h1>
    
    <div>
      <label for="languageSelect">Language / Sprache:</label>
      <select id="languageSelect">
        <option value="en">üá¨üáß English</option>
        <option value="de">üá©üá™ Deutsch</option>
      </select>
    </div>
    
    <div>
      <label for="voiceSelect">Select a voice:</label>
      <select id="voiceSelect"></select>
    </div>

    <h2>üìù Translate</h2>
    <textarea id="inputText" rows="4" placeholder="Enter text to translate...">Hello world</textarea>
    <button id="translateBtn">Translate</button>
    <div id="translated"></div>

    <h2>üîä Text-to-Speech</h2>
    <input id="ttsText" type="text" placeholder="Enter text to speak..." value="Hello from Asia's Panel" />
    <div class="button-group">
      <button id="ttsBtn">Generate TTS</button>
      <button id="replayBtn" disabled>üîÅ Replay</button>
    </div>
    <div id="audioHolder"></div>

    <h2>üéôÔ∏è Voice Recording</h2>
    <p style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 14px;">
      <strong>üìñ Sample Text (Read this for 30-60 seconds):</strong><br>
      <span id="sampleText"></span>
    </p>
    <div class="button-group">
      <button id="recordBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
    </div>
    <div id="recordTimer">Ready</div>
    <input id="voiceName" type="text" placeholder="Voice name (optional)" />
    <div id="recordStatus"></div>
    <div id="recordedAudio"></div>
    
    <h2>üóëÔ∏è Manage Cloned Voices</h2>
    <button id="manageVoicesBtn">Show/Delete Cloned Voices</button>
    <div id="voicesList" style="display:none; margin-top:12px;"></div>
  </div> <!-- End of mainApp -->

  <script>
    // ============ Authentication ============
    let authToken = null;
    
    // Auto-detect: production uses Azure backend, local uses localhost
    const API_BASE = window.location.hostname.includes('azurestaticapps.net') 
      ? 'https://asiaspanel-backend.azurewebsites.net' 
      : '';

    // Get auth headers
    function getAuthHeaders() {
      return authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
    }

    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', async () => {
      authToken = sessionStorage.getItem('authToken');
      
      if (authToken) {
        // Verify token is still valid
        const isValid = await verifyToken();
        if (isValid) {
          showMainApp();
          return;
        }
      }
      
      // Show login screen
      showLoginScreen();
    });

    async function verifyToken() {
      try {
        const response = await fetch(`${API_BASE}/api/voices`, {
          headers: getAuthHeaders()
        });
        return response.ok;
      } catch {
        return false;
      }
    }

    function showLoginScreen() {
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('passwordInput').focus();
    }

    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadVoices();
    }

    // Login handler
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    async function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('loginError');
      const loginBtn = document.getElementById('loginBtn');
      
      if (!password) {
        errorDiv.textContent = 'Please enter a password';
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      errorDiv.textContent = '';
      
      try {
        const response = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        
        if (!response.ok) {
          const error = await response.json();
          errorDiv.textContent = error.detail || 'Login failed';
          return;
        }
        
        const data = await response.json();
        authToken = data.token;
        sessionStorage.setItem('authToken', authToken);
        
        showMainApp();
      } catch (error) {
        errorDiv.textContent = 'Login failed: ' + error.message;
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch(`${API_BASE}/api/auth/logout`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
      } catch (error) {
        console.error('Logout error:', error);
      }
      
      authToken = null;
      sessionStorage.removeItem('authToken');
      document.getElementById('passwordInput').value = '';
      showLoginScreen();
    });

    // ============ Main App Logic ============
    
    // Sample texts for voice cloning
    const sampleTexts = {
      en: "Hello, my name is Asia. I love exploring new technologies and creating innovative solutions. Today is a beautiful day, and I'm excited to share my voice with you. Technology has transformed our world in countless ways, making communication easier and more accessible than ever before. Whether it's through text, speech, or video, we can now connect with people across the globe instantly. I believe in the power of artificial intelligence to enhance our daily lives. From virtual assistants to advanced translation tools, these innovations help us work smarter and collaborate better. Voice technology, in particular, has opened up amazing possibilities for accessibility and natural interaction with devices.",
      de: "Hallo, mein Name ist Asia. Ich liebe es, neue Technologien zu erkunden und innovative L√∂sungen zu entwickeln. Heute ist ein wundersch√∂ner Tag, und ich freue mich, meine Stimme mit Ihnen zu teilen. Technologie hat unsere Welt auf unz√§hlige Arten ver√§ndert und die Kommunikation einfacher und zug√§nglicher gemacht als je zuvor. Ob durch Text, Sprache oder Video ‚Äì wir k√∂nnen jetzt sofort mit Menschen auf der ganzen Welt in Verbindung treten. Ich glaube an die Kraft der k√ºnstlichen Intelligenz, unser t√§gliches Leben zu verbessern. Von virtuellen Assistenten bis hin zu fortschrittlichen √úbersetzungstools helfen uns diese Innovationen, intelligenter zu arbeiten und besser zusammenzuarbeiten. Sprachtechnologie hat insbesondere erstaunliche M√∂glichkeiten f√ºr Barrierefreiheit und nat√ºrliche Interaktion mit Ger√§ten er√∂ffnet."
    };

    let lastAudioElement = null;
    let currentLanguage = 'en';
    
    // Update sample text when language changes
    document.getElementById('languageSelect').addEventListener('change', (e) => {
      currentLanguage = e.target.value;
      document.getElementById('sampleText').textContent = sampleTexts[currentLanguage];
    });
    
    // Initialize sample text
    document.getElementById('sampleText').textContent = sampleTexts['en'];

    async function loadVoices() {
      try {
        // Load config voices
        const res = await fetch(API_BASE + '/api/config', {
          headers: getAuthHeaders()
        });
        const cfg = await res.json();
        
        // Load cloned voices
        const clonedRes = await fetch(API_BASE + '/api/cloned-voices', {
          headers: getAuthHeaders()
        });
        const clonedData = await clonedRes.json();
        
        const sel = document.getElementById('voiceSelect');
        sel.innerHTML = '';
        
        // Add OpenAI voices with gender labels
        const openaiVoices = [
          {id: 'alloy', label: 'Alloy (Neutral)'},
          {id: 'echo', label: 'Echo (Male)'},
          {id: 'fable', label: 'Fable (Male)'},
          {id: 'onyx', label: 'Onyx (Male)'},
          {id: 'nova', label: 'Nova (Female)'},
          {id: 'shimmer', label: 'Shimmer (Female)'},
          {id: 'ash', label: 'Ash (Male)'},
          {id: 'sage', label: 'Sage (Neutral)'},
          {id: 'coral', label: 'Coral (Female)'}
        ];
        const openaiGroup = document.createElement('optgroup');
        openaiGroup.label = 'OpenAI Voices';
        openaiVoices.forEach(v => {
          const o = document.createElement('option');
          o.value = v.id;
          o.textContent = v.label;
          openaiGroup.appendChild(o);
        });
        sel.appendChild(openaiGroup);
        
        // Add cloned voices
        if (clonedData.cloned_voices && clonedData.cloned_voices.length > 0) {
          const clonedGroup = document.createElement('optgroup');
          clonedGroup.label = 'üé§ Cloned Voices (ElevenLabs)';
          clonedData.cloned_voices.forEach(voice => {
            const o = document.createElement('option');
            o.value = voice.id;
            o.textContent = `${voice.name} (Custom)`;
            clonedGroup.appendChild(o);
          });
          sel.appendChild(clonedGroup);
        }
      } catch (e) {
        console.warn('Failed to load voices from /api/config, using defaults', e);
        const sel = document.getElementById('voiceSelect');
        ['alloy','echo','fable','onyx','nova','shimmer'].forEach(v => {
          const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o);
        });
      }
    }

    document.getElementById('translateBtn').addEventListener('click', async () => {
      const text = document.getElementById('inputText').value;
      const target = 'en';
      const res = await fetch(API_BASE + '/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
        body: JSON.stringify({text, target})
      });
      const body = await res.json();
      document.getElementById('translated').textContent = JSON.stringify(body);
    });

    document.getElementById('ttsBtn').addEventListener('click', async () => {
      const btn = document.getElementById('ttsBtn');
      const holder = document.getElementById('audioHolder');
      holder.innerHTML = 'Generating TTS...';
      btn.disabled = true;
      try {
        const text = document.getElementById('ttsText').value;
        const voice = document.getElementById('voiceSelect').value;
        const res = await fetch(API_BASE + '/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({text, voice, format: 'wav'})
        });

        if (!res.ok) {
          const txt = await res.text();
          holder.textContent = `TTS request failed: ${res.status} ${res.statusText} - ${txt}`;
          return;
        }

        let body;
        try {
          body = await res.json();
        } catch (e) {
          const txt = await res.text();
          holder.textContent = `Invalid JSON response from /api/tts: ${txt}`;
          console.error('Invalid JSON from /api/tts', txt, e);
          return;
        }

        // Check if response contains url before accessing it
        if (!body || !body.url) {
          console.error('Invalid TTS response:', body);
          holder.innerHTML = `<p style="color:red;">TTS failed: No audio URL in response. ${body?.error || ''}</p>`;
          if (body?.openai_error) {
            holder.innerHTML += `<p style="color:orange;">OpenAI error: ${body.openai_error}</p>`;
          }
          if (body?.mock) {
            holder.innerHTML += `<p style="color:orange;">Note: Using mock/fallback TTS</p>`;
          }
          return;
        }

        holder.innerHTML = '';
        const a = document.createElement('audio');
        a.controls = true;
        a.preload = 'auto';
        // For cross-origin audio sources, set crossOrigin so playback/reporting works
        try { a.crossOrigin = 'anonymous'; } catch(e) {}
        a.src = body.url;

        // Store reference for replay button
        lastAudioElement = a;
        document.getElementById('replayBtn').disabled = false;

        // show the audio control
        holder.appendChild(a);

        // Try to auto-play (user-initiated click should allow it). If it fails, surface the error and provide a direct link.
        a.addEventListener('error', (ev) => {
          console.error('Audio element error', ev, a.error);
          holder.innerHTML = `<p style="color:red;">Audio playback failed to load resource.</p><p><a href="${body.url}" target="_blank">Open audio in new tab</a></p>`;
        });

        // Try playing immediately; browsers may block, so catch and show helpful message
        a.play().then(() => {
          console.log('Audio started playing');
        }).catch(err => {
          console.warn('Auto-play blocked or playback failed:', err);
          // Keep controls visible so user can press play; also provide direct link
          const info = document.createElement('div');
          info.innerHTML = `<p>Audio ready ‚Äî press play or <a href="${body.url}" target="_blank">open in new tab</a></p>`;
          holder.appendChild(info);
        });
      } catch (err) {
        console.error('TTS request error', err);
        holder.innerHTML = `<p style="color:red;">TTS request error: ${err.message}</p>`;
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('replayBtn').addEventListener('click', () => {
      if (lastAudioElement) {
        lastAudioElement.currentTime = 0;
        lastAudioElement.play().then(() => {
          console.log('Replaying audio');
        }).catch(err => {
          console.warn('Replay failed:', err);
          alert('Replay failed. Please check the audio element.');
        });
      }
    });

    loadVoices();

    // Voice recording feature
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = 0;
    let timerInterval = null;

    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recordTimer = document.getElementById('recordTimer');
    const recordStatus = document.getElementById('recordStatus');
    const recordedAudio = document.getElementById('recordedAudio');
    const voiceName = document.getElementById('voiceName');

    recordBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Use webm with opus codec if available
        const options = { mimeType: 'audio/webm;codecs=opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'audio/webm';
        }
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = '';
        }
        
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];
        
        mediaRecorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });
        
        mediaRecorder.addEventListener('stop', async () => {
          const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
          
          // Show preview
          const audioUrl = URL.createObjectURL(audioBlob);
          recordedAudio.innerHTML = '<h3>Preview:</h3>';
          const preview = document.createElement('audio');
          preview.controls = true;
          preview.src = audioUrl;
          recordedAudio.appendChild(preview);
          
          // Upload to backend
          recordStatus.textContent = 'Uploading voice sample...';
          try {
            const formData = new FormData();
            const name = voiceName.value.trim() || 'my_voice';
            formData.append('file', audioBlob, `${name}.webm`);
            formData.append('name', name);
            
            const res = await fetch(API_BASE + '/api/voice-sample', {
              method: 'POST',
              headers: getAuthHeaders(),
              body: formData
            });
            
            if (!res.ok) {
              throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
            }
            
            const result = await res.json();
            recordStatus.innerHTML = `<p style="color:green;">‚úì Voice sample saved: ${result.voice_id}</p>`;
            
            // Add clone button
            const cloneBtn = document.createElement('button');
            cloneBtn.textContent = 'üé§ Clone This Voice with ElevenLabs';
            cloneBtn.style.marginTop = '10px';
            cloneBtn.onclick = async () => {
              const voiceName = prompt('Enter a name for this cloned voice:', result.name || result.voice_id);
              if (!voiceName) return;
              
              cloneBtn.disabled = true;
              cloneBtn.textContent = 'Cloning voice...';
              
              try {
                const cloneRes = await fetch(`${API_BASE}/api/clone-voice?voice_id=${result.voice_id}&name=${encodeURIComponent(voiceName)}`, {
                  method: 'POST',
                  headers: getAuthHeaders()
                });
                
                if (!cloneRes.ok) {
                  const error = await cloneRes.json();
                  throw new Error(error.detail || 'Cloning failed');
                }
                
                const cloneResult = await cloneRes.json();
                alert(`‚úÖ Voice cloned successfully!\n\nVoice ID: ${cloneResult.voice_id}\nElevenLabs ID: ${cloneResult.elevenlabs_id}`);
                
                // Reload voices
                await loadVoices();
                
              } catch (error) {
                alert(`‚ùå Voice cloning failed: ${error.message}`);
                cloneBtn.disabled = false;
                cloneBtn.textContent = 'üé§ Clone This Voice with ElevenLabs';
              }
            };
            
            recordStatus.appendChild(cloneBtn);
            
          } catch (err) {
            console.error('Upload error', err);
            recordStatus.innerHTML = `<p style="color:red;">Upload failed: ${err.message}</p>`;
          }
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        });
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        recordStatus.textContent = 'Recording...';
        
        // Update timer
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          recordTimer.textContent = `Recording: ${elapsed}s`;
        }, 1000);
        
      } catch (err) {
        console.error('Microphone access error', err);
        recordStatus.innerHTML = `<p style="color:red;">Microphone access denied or failed: ${err.message}</p>`;
      }
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        stopBtn.disabled = true;
        recordBtn.disabled = false;
        clearInterval(timerInterval);
        recordTimer.textContent = 'Processing...';
      }
    });

    // Manage cloned voices
    document.getElementById('manageVoicesBtn').addEventListener('click', async () => {
      const voicesList = document.getElementById('voicesList');
      
      if (voicesList.style.display === 'none') {
        // Show voices list
        try {
          const res = await fetch(API_BASE + '/api/cloned-voices', {
            headers: getAuthHeaders()
          });
          const data = await res.json();
          
          if (!data.cloned_voices || data.cloned_voices.length === 0) {
            voicesList.innerHTML = '<p style="color:#888;">No cloned voices yet.</p>';
          } else {
            voicesList.innerHTML = '<div style="display:flex; flex-direction:column; gap:8px;">' +
              data.cloned_voices.map(voice => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f5f5f5; border-radius:8px;">
                  <span><strong>${voice.name}</strong> <small style="color:#888;">(${voice.id})</small></span>
                  <button onclick="deleteVoice('${voice.id}')" style="background:#dc3545; padding:6px 12px; margin:0;">üóëÔ∏è Delete</button>
                </div>
              `).join('') +
              '</div>';
          }
          
          voicesList.style.display = 'block';
          document.getElementById('manageVoicesBtn').textContent = 'Hide Cloned Voices';
        } catch (err) {
          console.error('Failed to load voices:', err);
          voicesList.innerHTML = '<p style="color:red;">Failed to load voices.</p>';
          voicesList.style.display = 'block';
        }
      } else {
        // Hide voices list
        voicesList.style.display = 'none';
        document.getElementById('manageVoicesBtn').textContent = 'Show/Delete Cloned Voices';
      }
    });

    // Delete voice function (global so onclick can call it)
    window.deleteVoice = async function(voiceId) {
      if (!confirm(`Are you sure you want to delete voice "${voiceId}"?`)) {
        return;
      }
      
      try {
        const res = await fetch(`${API_BASE}/api/delete-cloned-voice?voice_id=${voiceId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        
        if (!res.ok) {
          throw new Error('Delete failed');
        }
        
        alert('‚úÖ Voice deleted successfully!');
        
        // Refresh voices list and dropdown
        document.getElementById('manageVoicesBtn').click(); // Close
        await loadVoices(); // Refresh dropdown
        document.getElementById('manageVoicesBtn').click(); // Reopen to show updated list
        
      } catch (err) {
        alert(`‚ùå Failed to delete voice: ${err.message}`);
      }
    };

  </script>
</body>
</html>
